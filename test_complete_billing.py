#!/usr/bin/env python3
"""
Test de la facturation compl√®te incluant PA, CM, UPR et 501/511.
"""

import sys
import os
import re
from pathlib import Path

# Add src to path
src_path = Path(__file__).parent / "src"
sys.path.insert(0, str(src_path))

def test_complete_billing_html():
    """Test que le HTML contient toutes les sections de facturation."""
    print("üîç Test de la Structure HTML Facturation Compl√®te")
    print("=" * 60)
    
    try:
        html_file = Path(__file__).parent / "src" / "pres stats" / "index.html"
        
        if not html_file.exists():
            print(f"   ‚ùå Fichier HTML non trouv√©")
            return False
        
        with open(html_file, 'r', encoding='utf-8') as f:
            html_content = f.read()
        
        # V√©rifier toutes les sections de facturation
        sections = [
            ('Section PA', 'üìã Prix PA (Acts) par Motif'),
            ('Section CM', 'üìä Prix CM par Motif'),
            ('Section UPR', 'üé´ Prix Tickets UPR par Motif'),
            ('Section 501/511', 'üìã Prix Tickets 501/511')
        ]
        
        print(f"   üìä V√©rification des sections:")
        sections_found = 0
        for section_name, section_text in sections:
            if section_text in html_content:
                print(f"      ‚úÖ {section_name}: Trouv√©e")
                sections_found += 1
            else:
                print(f"      ‚ùå {section_name}: Manquante")
        
        # V√©rifier les motifs UPR
        upr_motifs = ['UPR Cr√©√©', 'UPR Non']
        print(f"\n   üé´ V√©rification des motifs UPR:")
        upr_found = 0
        for motif in upr_motifs:
            if motif in html_content:
                print(f"      ‚úÖ {motif}: Trouv√©")
                upr_found += 1
            else:
                print(f"      ‚ùå {motif}: Manquant")
        
        # V√©rifier les inputs de prix UPR et 501/511
        new_price_inputs = [
            'price-upr-cree', 'price-upr-non', 'price-tickets-501511'
        ]
        
        print(f"\n   üí∂ V√©rification des nouveaux inputs de prix:")
        new_inputs_found = 0
        for price_id in new_price_inputs:
            if f'id="{price_id}"' in html_content:
                print(f"      ‚úÖ {price_id}: Input trouv√©")
                new_inputs_found += 1
            else:
                print(f"      ‚ùå {price_id}: Input manquant")
        
        # V√©rifier les totaux
        total_elements = ['totalUPR', 'total501511', 'grandTotal']
        print(f"\n   üìä V√©rification des totaux:")
        totals_found = 0
        for total_id in total_elements:
            if f'id="{total_id}"' in html_content:
                print(f"      ‚úÖ {total_id}: √âl√©ment trouv√©")
                totals_found += 1
            else:
                print(f"      ‚ùå {total_id}: √âl√©ment manquant")
        
        total_checks = sections_found + upr_found + new_inputs_found + totals_found
        expected_total = len(sections) + len(upr_motifs) + len(new_price_inputs) + len(total_elements)
        
        if total_checks >= expected_total - 1:  # Tol√©rance de 1
            print(f"\n   ‚úÖ Structure HTML compl√®te correcte ({total_checks}/{expected_total})")
            return True
        else:
            print(f"\n   ‚ùå Structure HTML compl√®te incompl√®te ({total_checks}/{expected_total})")
            return False
        
    except Exception as e:
        print(f"   ‚ùå Erreur lors du test HTML: {e}")
        return False

def test_complete_billing_css():
    """Test que les styles CSS pour toutes les sections sont pr√©sents."""
    print("\nüé® Test des Styles CSS Facturation Compl√®te")
    print("=" * 60)
    
    try:
        css_file = Path(__file__).parent / "src" / "pres stats" / "styles.css"
        
        if not css_file.exists():
            print(f"   ‚ùå Fichier CSS non trouv√©")
            return False
        
        with open(css_file, 'r', encoding='utf-8') as f:
            css_content = f.read()
        
        # V√©rifier les nouveaux styles
        css_classes = [
            ('UPR grid', '.motif-pricing-grid.upr-grid'),
            ('501/511 grid', '.motif-pricing-grid.tickets-501511-grid'),
            ('UPR section total', '.upr-section-total'),
            ('501/511 section total', '.tickets-501511-section-total')
        ]
        
        passed_checks = 0
        for check_name, css_class in css_classes:
            if css_class in css_content:
                print(f"   ‚úÖ {check_name}: Style d√©fini")
                passed_checks += 1
            else:
                print(f"   ‚ùå {check_name}: Style manquant")
        
        # V√©rifier les couleurs sp√©cifiques
        color_checks = [
            ('Couleur UPR orange', '#ff9800'),
            ('Couleur 501/511 violette', '#9c27b0'),
            ('Gradient UPR', 'linear-gradient(135deg, #fff3e0'),
            ('Gradient 501/511', 'linear-gradient(135deg, #f3e5f5')
        ]
        
        for check_name, pattern in color_checks:
            if pattern in css_content:
                print(f"   ‚úÖ {check_name}: Couleur d√©finie")
                passed_checks += 1
            else:
                print(f"   ‚ùå {check_name}: Couleur manquante")
        
        if passed_checks >= 7:  # Au moins 7 sur 8
            print(f"   ‚úÖ Styles CSS complets ({passed_checks}/8)")
            return True
        else:
            print(f"   ‚ùå Styles CSS incomplets ({passed_checks}/8)")
            return False
        
    except Exception as e:
        print(f"   ‚ùå Erreur lors du test CSS: {e}")
        return False

def test_complete_billing_javascript():
    """Test que le JavaScript g√®re toutes les sections."""
    print("\nüíª Test du JavaScript Facturation Compl√®te")
    print("=" * 60)
    
    try:
        js_file = Path(__file__).parent / "src" / "pres stats" / "script.js"
        
        if not js_file.exists():
            print(f"   ‚ùå Fichier JavaScript non trouv√©")
            return False
        
        with open(js_file, 'r', encoding='utf-8') as f:
            js_content = f.read()
        
        # V√©rifier les nouveaux arrays de motifs
        js_elements = [
            ('UPR motifs array', 'this.uprMotifs'),
            ('501/511 motifs array', 'this.tickets501511Motifs'),
            ('UPR event listeners', 'this.uprMotifs.forEach'),
            ('501/511 event listeners', 'this.tickets501511Motifs.forEach'),
            ('UPR calculations', 'totalUPR'),
            ('501/511 calculations', 'total501511'),
            ('Updated updateWithRealData', 'updateWithRealData(paData, cmData, uprData, tickets501511Data)')
        ]
        
        passed_checks = 0
        for check_name, pattern in js_elements:
            if pattern in js_content:
                print(f"   ‚úÖ {check_name}: Impl√©ment√©")
                passed_checks += 1
            else:
                print(f"   ‚ùå {check_name}: Manquant")
        
        # V√©rifier les IDs sp√©cifiques
        id_checks = [
            ('UPR Cr√©√© ID', 'upr-cree'),
            ('UPR Non ID', 'upr-non'),
            ('Tickets 501/511 ID', 'tickets-501511')
        ]
        
        for check_name, pattern in id_checks:
            if pattern in js_content:
                print(f"   ‚úÖ {check_name}: D√©fini")
                passed_checks += 1
            else:
                print(f"   ‚ùå {check_name}: Manquant")
        
        if passed_checks >= 9:  # Au moins 9 sur 10
            print(f"   ‚úÖ JavaScript complet ({passed_checks}/10)")
            return True
        else:
            print(f"   ‚ùå JavaScript incomplet ({passed_checks}/10)")
            return False
        
    except Exception as e:
        print(f"   ‚ùå Erreur lors du test JavaScript: {e}")
        return False

def test_python_complete_integration():
    """Test que l'int√©gration Python g√®re toutes les sections."""
    print("\nüêç Test de l'Int√©gration Python Compl√®te")
    print("=" * 60)
    
    try:
        from ui.modules.team_stats_module import TeamStatsModule
        
        # V√©rifier le code source pour les nouvelles donn√©es
        import inspect
        source = inspect.getsource(TeamStatsModule._update_facturation_data)
        
        integration_checks = [
            ('UPR motif data', 'upr_motif_data'),
            ('501/511 data', 'tickets_501511_data'),
            ('UPR extraction', 'upr_data'),
            ('501/511 extraction', 'tickets_501511_mapping'),
            ('UPR total', 'upr_total'),
            ('501/511 total', 'tickets_501511_total'),
            ('UPR motifs storage', 'upr_motifs'),
            ('501/511 motifs storage', 'tickets_501511_motifs')
        ]
        
        passed_checks = 0
        for check_name, pattern in integration_checks:
            if pattern in source:
                print(f"   ‚úÖ {check_name}: Impl√©ment√©")
                passed_checks += 1
            else:
                print(f"   ‚ùå {check_name}: Manquant")
        
        # V√©rifier la mise √† jour script.js
        script_source = inspect.getsource(TeamStatsModule._update_script_js_values)
        
        script_checks = [
            ('UPR data string', 'upr_data_str'),
            ('501/511 data string', 'tickets_501511_data_str'),
            ('4 parameters update', 'uprData, tickets501511Data')
        ]
        
        for check_name, pattern in script_checks:
            if pattern in script_source:
                print(f"   ‚úÖ {check_name}: Impl√©ment√©")
                passed_checks += 1
            else:
                print(f"   ‚ùå {check_name}: Manquant")
        
        if passed_checks >= 10:  # Au moins 10 sur 11
            print(f"   ‚úÖ Int√©gration Python compl√®te ({passed_checks}/11)")
            return True
        else:
            print(f"   ‚ùå Int√©gration Python incompl√®te ({passed_checks}/11)")
            return False
        
    except Exception as e:
        print(f"   ‚ùå Erreur lors du test Python: {e}")
        return False

def main():
    """Fonction principale de test."""
    print("üöÄ Test de la Facturation Compl√®te (PA + CM + UPR + 501/511)")
    print("=" * 80)
    
    tests_passed = 0
    total_tests = 4
    
    # Test 1: Structure HTML compl√®te
    if test_complete_billing_html():
        tests_passed += 1
        print("\n‚úÖ Test 1 R√âUSSI: Structure HTML compl√®te")
    else:
        print("\n‚ùå Test 1 √âCHOU√â: Structure HTML compl√®te")
    
    # Test 2: Styles CSS complets
    if test_complete_billing_css():
        tests_passed += 1
        print("\n‚úÖ Test 2 R√âUSSI: Styles CSS complets")
    else:
        print("\n‚ùå Test 2 √âCHOU√â: Styles CSS complets")
    
    # Test 3: JavaScript complet
    if test_complete_billing_javascript():
        tests_passed += 1
        print("\n‚úÖ Test 3 R√âUSSI: JavaScript complet")
    else:
        print("\n‚ùå Test 3 √âCHOU√â: JavaScript complet")
    
    # Test 4: Int√©gration Python compl√®te
    if test_python_complete_integration():
        tests_passed += 1
        print("\n‚úÖ Test 4 R√âUSSI: Int√©gration Python compl√®te")
    else:
        print("\n‚ùå Test 4 √âCHOU√â: Int√©gration Python compl√®te")
    
    # R√©sum√©
    print("\n" + "=" * 80)
    print(f"üìä R√©sultats: {tests_passed}/{total_tests} tests r√©ussis")
    
    if tests_passed == total_tests:
        print("üéâ TOUS LES TESTS R√âUSSIS!")
        print("\n‚úÖ Facturation compl√®te avec 4 sections impl√©ment√©e!")
        
        print("\nüéØ Sections de facturation:")
        print("\nüìã PA (Acts) - 10 motifs individuels:")
        print("  ‚Ä¢ AD RAS sans temps, AD RAS avec temps, OK, NOK")
        print("  ‚Ä¢ AD Non jointe, UPR RAS, AD Non trouv√©e")
        print("  ‚Ä¢ Hors commune, UPR NOK, UPR OK")
        
        print("\nüìä CM - 3 motifs individuels:")
        print("  ‚Ä¢ RAF, Modification, Cr√©ation")
        
        print("\nüé´ UPR - 2 motifs individuels:")
        print("  ‚Ä¢ UPR Cr√©√©, UPR Non")
        
        print("\nüìã 501/511 - 1 motif:")
        print("  ‚Ä¢ Tickets 501/511")
        
        print("\nüí∂ Calculs automatiques:")
        print("  ‚Ä¢ Total par motif: Count √ó Prix individuel")
        print("  ‚Ä¢ Total PA: Somme de tous les motifs PA")
        print("  ‚Ä¢ Total CM: Somme de tous les motifs CM")
        print("  ‚Ä¢ Total UPR: Somme de tous les motifs UPR")
        print("  ‚Ä¢ Total 501/511: Count √ó Prix")
        print("  ‚Ä¢ Grand Total: PA + CM + UPR + 501/511")
        
        print("\nüìä Exemple complet:")
        print("  PA: ‚Ç¨26,503.20 (10 motifs)")
        print("  CM: ‚Ç¨3,714.00 (3 motifs)")
        print("  UPR: ‚Ç¨246.00 (2 motifs)")
        print("  501/511: ‚Ç¨343.00 (1 motif)")
        print("  Grand Total: ‚Ç¨30,806.20")
        
        print("\nüé® Interface:")
        print("  ‚Ä¢ 4 sections distinctes avec couleurs diff√©renci√©es")
        print("  ‚Ä¢ 16 inputs de prix individuels (10+3+2+1)")
        print("  ‚Ä¢ 4 totaux de section + 1 grand total")
        print("  ‚Ä¢ Grid responsive adaptatif")
        
        print("\nüöÄ Facturation compl√®te pr√™te!")
        return True
    else:
        print(f"‚ö†Ô∏è {total_tests - tests_passed} test(s) √©chou√©(s).")
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
